# GMP Draft

## å…³äºæœ¬æ–‡

æœ¬æ–‡åªæ˜¯ç®€å•æ¨¡æ‹Ÿäº†Golangä¸­GMPçš„åŸºæœ¬è°ƒåº¦æ–¹æ¡ˆï¼Œå¹¶ä¸æ˜¯çœŸæ­£Golangçš„å®ç°åŸç†ã€‚demoåªåœ¨Ubuntu(20.04, intel x64å¹³å°)ç‰©ç†æœºï¼Œå’ŒUbuntué•œåƒ(tag:20.04ï¼Œmacç‰©ç†æœº)ä¸‹æµ‹è¯•é€šè¿‡ã€‚demoå¹¶ä¸æ˜¯ä¸€æ°”å‘µæˆå®ç°äº†gmpçš„è°ƒåº¦æ–¹æ¡ˆï¼Œè€Œæ˜¯å¾ªåºæ¸è¿›çš„æ–¹å¼ï¼Œæ¯æ¬¡è¿­ä»£éƒ½åœ¨ä¸åŒçš„åˆ†æ”¯ã€‚

## å…³äºGolang GMP

è™½ç„¶demoæ˜¯å…³äºGMPçš„æ˜¯å®ç°ï¼Œä½†è¿™é‡Œå¹¶ä¸æ‰“ç®—è¯¦ç»†è®²è§£GMPçš„è°ƒåº¦åŸç†ï¼ˆè¯¦ç»†çš„å…³äºGMPä»‹ç»çš„æ–‡ç« æœ€åä¼šç»™å‡ºé“¾æ¥ï¼‰ï¼Œç°åœ¨åªæ˜¯ç®€å•è§£é‡Šä¸€ä¸‹GMPçš„æ¦‚å¿µã€‚
G:ä»£è¡¨çš„æ˜¯Coroutineï¼Œå¯æ‰§è¡Œçš„Goç¨‹åºã€‚M: ä»£è¡¨çš„æ˜¯OS Threadã€‚P:ä»£è¡¨çš„æ˜¯Logical Processorä¹Ÿå¯ä»¥ç†è§£æˆContextã€‚


## feat/demo-0.0.1

ç¬¬ä¸€ä¸ªæœ€ç®€å•çš„ç‰ˆæœ¬ä»£ç åœ¨åˆ†æ”¯`feat/demo-0.0.1` ã€‚è¿™ä¸ªç‰ˆæœ¬æ€»ä½“æ¥è¯´å…¶å®æ˜¯ä¸€ä¸ª`ç”Ÿäº§è€…-æ¶ˆè´¹è€…`æ¨¡å‹ã€‚    
G: å°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„`func`ã€‚    
P: åªç»´æŠ¤äº†ä¸€ä¸ªLRQ(Local Run Queue)é˜Ÿåˆ—ï¼ŒG ä¼š enqueue/dequeueã€‚   
M: ç›¸å½“äºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œä¸Pç»‘å®šã€‚   
Schedï¼š ç»´æŠ¤äº†ä¸€ä¸ªGRQ(Global Run Queue)ã€‚   
ç”Ÿäº§è€…: ä¸»çº¿ç¨‹Mç”Ÿäº§Gï¼Œå¹¶æ”¾å…¥GRQé˜Ÿåˆ—ä¸­ã€‚   
æ¶ˆè´¹è€…: æ¶ˆè´¹çº¿ç¨‹Mä»LRQè·å–Gï¼Œè‹¥LRQæ²¡æœ‰ï¼Œåˆ™ä»GRQä¸­è·å–Gå¹¶æ”¾å…¥LRQä¸­ï¼Œæœ€ç»ˆè¿˜æ˜¯ä»LRQä¸­è·å–Gï¼Œå¹¶æ‰§è¡Œï¼Œè‹¥æ²¡æœ‰Gï¼Œåˆ™é˜»å¡ã€‚

![0.0.1](./images/0.0.1.png)

å¯é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œç¼–è¯‘æ‰§è¡Œ
> gcc -pthread hello.c -o hello   
>  ./hello

è¿™ä¸ªç‰ˆæœ¬çš„Gè¿˜æ˜¯è¿è¡Œåœ¨çº¿ç¨‹Mçš„æ ˆç©ºé—´ï¼Œå¹¶ä¸æ˜¯è‡ªå·±çš„æ ˆç©ºé—´ä¸Šã€‚ä¸‹ä¸ªç‰ˆæœ¬å®ç°è®©Gè¿è¡Œåœ¨è‡ªå·±çš„æ ˆç©ºé—´ã€‚   
è¯·åˆ‡åˆ°åˆ†æ”¯`feat/demo-0.0.2`

## feat/demo-0.0.2

è¿™ä¸ªç‰ˆæœ¬åªä¿®æ”¹äº†ä¸€ç‚¹é€»è¾‘ã€‚å°†æ‰§è¡ŒGçš„å‡½æ•°æ‰§è¡Œæ–¹å¼ `g->f()`ï¼Œæ¢æˆäº†`cr_call`ã€‚ç„¶åç»™æ¯ä¸ªGåˆ†é…äº†ä¸€å—å†…å­˜åŒºåŸŸã€‚

```c
// feat/demo-0.0.1
int clone_start(M* mm)
{
	P* p = mm->p;

	while (1) {
		G* g = get_g(p);
		g->f();
	}

	return 0;
}

//  feat/demo-0.0.2
void* schedule()
{
	G* g = get_g(m->p);

	cr_call(&g->gobuf, g->f);

	return NULL;
}
```

æƒ³è¦Gè¿è¡Œåœ¨è‡ªå·±çš„æ ˆç©ºé—´ï¼Œå¾—ç»™Gåˆ†é…ä¸€å—å†…å­˜åŒºåŸŸä¾›Gä½œä¸ºæ ˆæ¥ä½¿ç”¨ï¼Œå¹¶ç”¨`stack_base`æŒ‡é’ˆæŒ‡å‘åˆ†é…ç©ºé—´çš„é«˜åœ°å€ï¼ˆæ ˆåº•æ˜¯é«˜åœ°å€ï¼Œæ ˆé¡¶æ˜¯ä½åœ°å€ï¼‰ã€‚åœ¨æ‰§è¡ŒGçš„å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å°†å¯„å­˜å™¨`SP`ï¼ˆæ ˆé¡¶æŒ‡é’ˆï¼‰,`BP`ï¼ˆæ ˆåº•æŒ‡é’ˆï¼‰è®¾ç½®æˆ`stack_base`çš„å€¼ï¼Œè¿™æ ·Gçš„å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå°±è¿è¡Œåœ¨äº†è‡ªå·±çš„æ ˆç©ºé—´ä¸Šï¼Œæ ˆåº•æ˜¯`stack_base`ã€‚æ±‡ç¼–å‡½æ•°`cr_call(Gobuf*, Fn)`å®ç°äº†è¿™ä¸ªçš„åŠŸèƒ½ã€‚


```c
cr_call:

movq (%rdi), %rax
movq %rax, %rsp
movq %rsp, %rbp

// push buf.pc
movq 8(%rdi), %rax
pushq %rax

movq %rsi, %rax
// call f
jmp *%rax

ret
```

æ ¹æ®Cè¯­è¨€å‡½æ•°è°ƒç”¨è§„çº¦ï¼Œå‰6ä¸ªå‚æ•°ä¾æ¬¡é€šè¿‡å¯„å­˜å™¨ä¼ é€’`rdi`,`rsi`,`rdx`,`rcx`,`r8`,`r9`ï¼ˆx64 å¹³å°ï¼‰ã€‚å› æ­¤å‚æ•°`Gobuf*`çš„å€¼åœ¨`rdi`å¯„å­˜å™¨ï¼Œ`Fn`çš„å€¼åœ¨`rsi`å¯„å­˜å™¨ã€‚

1. å°†`rsp`, `rbp`è®¾ç½®æˆ`stack_base`çš„å€¼ã€‚
2. å°†`Gobuf.pc`çš„å€¼å‹æ ˆï¼Œå³å°†`gexit`å‡½æ•°åœ°å€å‹æ ˆã€‚
3. æ‰§è¡Œå‡½æ•°`Fn`ã€‚å³`jmp`åˆ°å‡½æ•°`Fn`çš„åœ°å€ã€‚`jmp`ä¼šä¿®æ”¹`pc`çš„å€¼ã€‚


å¯¹ç¬¬2é¡¹è¿›è¡Œè§£é‡Šã€‚å°†`gexit`å‡½æ•°åœ°å€å‹æ ˆï¼Œæ˜¯å¾…å‡½æ•°`Fn`æ‰§è¡Œå®Œæˆåï¼Œç„¶åå†æ‰§è¡Œ`gexit`ã€‚å› ä¸ºå‡½æ•°`Fn`çš„æœ€åä¸€æ¡æŒ‡ä»¤ä¸€å®šæ˜¯`ret`ï¼Œå®ƒçš„ä½œç”¨ç›¸å½“äºæ˜¯å‡ºæ ˆï¼Œæ‰§è¡Œã€‚å› æ­¤åœ¨`Fn`æ‰§è¡Œå®Œåï¼Œä¼šå¼¹å‡º`gexit`ï¼Œç„¶åæ‰§è¡Œ`gexit`ï¼Œè¿›è¡Œè°ƒåº¦ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªGï¼Œè¿™æ ·å°±åˆ°è¾¾äº†`feat/demo-0.0.1`åˆ†æ”¯é‡Œé¢çš„`while(1)`çš„åŠŸèƒ½ã€‚

![0.0.2](./images/0.0.2.png)


è¿™ä¸ªç‰ˆæœ¬åªæ˜¯åœ¨å‡½æ•°`Fn`æ‰§è¡Œå®Œæˆåè¿›è¡Œè°ƒåº¦ã€‚å¹¶ä¸æ˜¯åƒGolangçš„åä½œå¼è°ƒåº¦ï¼Œè¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶è°ƒåº¦ã€‚ä¸‹ä¸ªç‰ˆæœ¬å®ç°*åä½œå¼è°ƒåº¦*ï¼ˆğŸ¤£ï¼‰ã€‚

è¯·åˆ‡åˆ°åˆ†æ”¯`feat/demo-0.0.3`


## feat/demo-0.0.3

è¿™ä¸ªç‰ˆæœ¬å°†åœ¨è¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶è¿›è¡Œè°ƒåº¦ã€‚å½“ç„¶å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½è¿›è¡Œè°ƒåº¦ï¼Œåªæ˜¯hookäº†`printf`å‡½æ•°ï¼Œä¿®æ”¹ä¸º`write_call`ï¼Œåªåœ¨æ‰§è¡Œ`write_call`å‡½æ•°æ—¶æ‰ä¼šè¿›è¡Œè°ƒåº¦ã€‚

æ€»ä½“æ”¹åŠ¨ä¹Ÿä¸å¤§ï¼Œå¢åŠ äº†3ä¸ªæ±‡ç¼–å‡½æ•°`write_call`, `cr_schedule`, `cr_switch`ã€‚

- `write_call` æ˜¯è°ƒç”¨ç³»ç»Ÿå‡½æ•°`write`å°†å†…å®¹æ‰“å°åœ¨`stdout`ï¼Œåœ¨è°ƒç”¨ä¹‹å‰è¿›è¡Œ*åä½œå¼è°ƒåº¦*ï¼ˆä¿å­˜ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªG)ã€‚
- `cr_schedule` ä¿å­˜å½“å‰Gçš„`Gobuf`ï¼Œå³`sp`,`pc`ã€‚ç„¶åå†æ‰§è¡Œ`schedule`è°ƒåº¦ï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ªå¯æ‰§è¡ŒGï¼Œæ‰§è¡Œã€‚
- `cr_switch` é‡æ–°æ‰§è¡Œä¹‹å‰è¢«è°ƒåº¦çš„Gï¼Œæ¢å¤Gæ‰§è¡Œçš„ä¸Šä¸‹æ–‡ã€‚

åœ¨è°ƒç”¨`cr_schedule`æ—¶ï¼Œæ ˆå¸ƒå±€å¦‚å›¾

![0.0.3-1](./images/0.0.3-1.png)

`call`æŒ‡ä»¤é¦–å…ˆä¼šå°†ä¸‹ä¸€æ®µè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€`push`åˆ°æ ˆä¸­ã€‚å³`rsp`å¯„å­˜å™¨æ‰€æŒ‡å‘çš„å†…å­˜çš„å€¼æ˜¯`pc`å°†è¦æ‰§è¡Œçš„åœ°å€ï¼ˆ`call cr_schedule`ï¼Œ`cr_schedule`å‡½æ•°æ‰§è¡Œå®Œæˆåï¼Œå°±æ‰§è¡Œ`pc`åœ°å€æŒ‡ä»¤ï¼Œå’Œ`gexit`è¢«æ‰§è¡Œçš„é€»è¾‘ä¸€æ ·ï¼Œ`cr_schedule`æ‰§è¡Œ`ret`åï¼Œ`saved pc`è¢«å¼¹æ ˆï¼Œæ‰§è¡Œï¼‰ã€‚

```c
cr_schedule:

    // å½“å‰æ­£åœ¨æ‰§è¡Œçš„Gçš„åœ°å€ -> rax
	movq %fs:g@tpoff, %rax
    // &g.gobuf -> rax
	leaq 8(%rax), %rax

    // spä½œä¸ºå‚æ•°ä¼ é€’ï¼Œsp -> gobuf.sp
	movq %rdi, (%rax)
	movq (%rsp), %rdx
    // saved pc -> pc
	movq %rdx, 8(%rax)

	call schedule
ret
```


æ‰§è¡Œå®Œ`cr_schedule`åï¼Œæ ˆå¸ƒå±€å¦‚å›¾

![0.0.3-2](./images/0.0.3-2.png)

æ­¤æ—¶`gobuf.pc`ä¿å­˜äº†ä¸‹ä¸€æ®µè¦æ‰§è¡Œçš„æŒ‡ä»¤`RESTORE_REG`ï¼ˆä¸è¦åœ¨æ„å®å±•å¼€ï¼‰ã€‚`gobuf.sp`æŒ‡å‘çš„æ˜¯`ä¿å­˜çš„å¯„å­˜å™¨`çš„æ ˆé¡¶ã€‚ä¸Šä¸‹æ–‡éƒ½å·²ç»å‹æ ˆã€‚æ­¤æ—¶ï¼Œå¯ä»¥æ”¾å¿ƒçš„åˆ‡æ¢åˆ°å…¶ä»–çš„Gå»æ‰§è¡Œäº†ã€‚

å¦‚ä½•æ¢å¤Gçš„æ‰§è¡Œå‘¢ï¼Ÿ`cr_switch`

æˆ‘ä»¬å°†Gè°ƒåº¦çš„æ—¶å€™ï¼ŒGæ‰§è¡Œåˆ°äº†å‡½æ•°`write_call`çš„`call cr_schedule`è¿™æ®µæŒ‡ä»¤ï¼Œåé¢å³å°†æ‰§è¡Œ`RESTORE_REG`ã€‚å› æ­¤åœ¨æ¢å¤Gæ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®©Gç»§ç»­æ‰§è¡Œ`RESTORE_REG`ã€‚

```c
// cr_switch(Gobuf *buf)
cr_switch:

    // gobuf.sp -> rsp
	movq (%rdi), %rsp
    // gobuf.pc -> rax
	movq 8(%rdi), %rax

    // æ‰§è¡Œpcå¤„çš„æŒ‡ä»¤
	jmp *%rax
ret
```
åœ¨æ‰§è¡Œ`cr_switch`ä¹‹å‰ï¼Œæ ˆçš„å¸ƒå±€å¦‚ä¸Šå›¾ã€‚åœ¨æ‰§è¡Œåˆ°`movq 8(%rdi), %rax`æŒ‡ä»¤åï¼Œå¸ƒå±€å¦‚ä¸‹å›¾

![0.0.3-3](./images/0.0.3-3.png)

`rsp`çš„å€¼æ­£å¥½æ˜¯äº†`ä¿å­˜çš„å¯„å­˜å™¨`çš„é¡¶ç«¯ï¼Œç„¶å`jmp *%rax`æ‰§è¡Œ`RESTORE_REG`å°†å¯„å­˜å™¨çš„å€¼éƒ½å‡ºæ ˆã€‚æ¢å¤äº†Gçš„ä¸Šä¸‹æ–‡ï¼Œç»§ç»­æ‰§è¡Œã€‚

ä»¥ä¸Šè™½ç„¶å®Œæˆäº†Gè¿è¡Œåœ¨è‡ªå·±çš„æ ˆç©ºé—´å’Œåä½œå¼è°ƒåº¦ï¼Œä½†ä¾æ—§æ˜¯åŸºäº`ç”Ÿäº§è€…-æ¶ˆè´¹è€…`æ¨¡å‹ã€‚ä¸»çº¿ç¨‹åªèƒ½æŠŠG `enqueue` åˆ°`GRQ`ä¸­ï¼Œå¹¶ä¸èƒ½ä½œä¸ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥è°ƒåº¦ã€‚ä¸‹ä¸€ä¸ªç‰ˆæœ¬å°†ä¸»çº¿ç¨‹å®ç°æˆM0ï¼Œè®©M0å¯ä½œä¸ºå·¥ä½œçº¿ç¨‹ã€‚

è¯·åˆ‡åˆ°åˆ†æ”¯`feat/demo-0.0.4`


### Ref

- å›¾ç‰‡ç”¨ [draw.io](https://app.diagrams.net/) ç»˜åˆ¶
- https://qcrao91.gitbook.io/go/goroutine-tiao-du-qi
- https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-goroutine/
- https://morsmachine.dk/go-scheduler
- https://morsmachine.dk/netpoller
- https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part1.html
- https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html
- https://www.ardanlabs.com/blog/2018/12/scheduling-in-go-part3.html
- ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ç¬¬3ç‰ˆ
- ã€Šæ“ä½œç³»ç»ŸçœŸè±¡è¿˜åŸã€‹éƒ‘é’¢è‘—